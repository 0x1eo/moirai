---
import Layout from "../../layouts/Layout.astro";

const webhookPayload = `{
  "node": "athena",
  "entropy": 0.87,
  "timestamp": "2026-01-18T00:15:00Z"
}`;
---

<Layout
    title="Lachesis"
    description="The Measurer - Compliance Trend Dashboard"
>
    <div class="doc-layout">
        <aside class="sidebar">
            <nav>
                <a href="/moirai/lachesis/" class="active">Overview</a>
                <a href="/moirai/lachesis/api/">API Reference</a>
                <a href="/moirai/lachesis/dashboard/">Dashboard</a>
            </nav>
        </aside>

        <article class="content">
            <header class="doc-header">
                <span class="badge badge-node">Node.js + Angular</span>
                <h1>Lachesis</h1>
                <p class="subtitle">The Measurer of the Thread</p>
            </header>

            <section>
                <p>
                    Lachesis is a dashboard for tracking compliance over time.
                    It ingests JSON reports from Clotho, stores them in MariaDB,
                    and shows pretty graphs. It calculates entropy, stability,
                    and MTBF (Mean Time Between Failures) to tell you when
                    systems are "fraying" - drifting from baseline.
                </p>

                <blockquote>
                    In Greek mythology, Lachesis measured the thread of life,
                    determining how long it would last. This Lachesis measures
                    system health - how long until the next compliance breach.
                </blockquote>
            </section>

            <section>
                <h2>Architecture</h2>
                <div class="arch-grid">
                    <div class="arch-item">
                        <h3>API Server</h3>
                        <p>
                            Express.js backend on port 6380. TypeORM with
                            MariaDB for persistence.
                        </p>
                    </div>
                    <div class="arch-item">
                        <h3>Dashboard</h3>
                        <p>
                            Angular 17 SPA on port 4200. Real-time charts and
                            node timelines.
                        </p>
                    </div>
                </div>
            </section>

            <section>
                <h2>Installation</h2>

                <h3>Database Setup</h3>
                <pre><code>sudo mariadb -e "
  CREATE DATABASE monitor;
  CREATE USER 'lachesis'@'localhost' IDENTIFIED BY 'changeme';
  GRANT ALL ON monitor.* TO 'lachesis'@'localhost';
"</code></pre>
                <p class="note">
                    Tables auto-create on first run via TypeORM migrations.
                </p>

                <h3>API Server</h3>
                <pre><code>cd api
npm install
npm run dev  # Port 6380</code></pre>

                <h3>Dashboard</h3>
                <pre><code>cd dashboard
npm install
npm start  # Port 4200</code></pre>
            </section>

            <section>
                <h2>Key Metrics</h2>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-name">Entropy</div>
                        <div class="metric-desc">
                            Weighted score of failed controls. Higher = worse.
                            <code>0.0</code> is perfect compliance, <code
                                >1.0</code
                            > is total failure.
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-name">Stability</div>
                        <div class="metric-desc">
                            Time since last failure divided by total uptime.
                            Higher = more stable.
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-name">MTBF</div>
                        <div class="metric-desc">
                            Mean Time Between Fray events. Average time between
                            compliance breaches.
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h2>Data Flow</h2>
                <ol>
                    <li>
                        <strong>Clotho runs audit</strong> → Generates JSON report
                    </li>
                    <li>
                        <strong>Report ingested</strong> → <code
                            >POST /api/ingest</code
                        >
                    </li>
                    <li>
                        <strong>Lachesis stores</strong> → Findings saved to MariaDB
                    </li>
                    <li>
                        <strong>Entropy calculated</strong> → Based on failed control
                        weights
                    </li>
                    <li>
                        <strong>Threshold check</strong> → If entropy &gt; threshold,
                        webhook to Atropos
                    </li>
                </ol>
            </section>

            <section>
                <h2>Integration with Atropos</h2>
                <p>
                    When entropy exceeds a configured threshold, Lachesis can
                    send a webhook to Atropos:
                </p>
                <pre><code set:text={webhookPayload} /></pre>
                <p>
                    Atropos will then select the appropriate remediation
                    strategy based on the entropy level.
                </p>
            </section>
        </article>
    </div>
</Layout>

<style>
    .doc-layout {
        display: grid;
        grid-template-columns: 220px 1fr;
        max-width: 1200px;
        margin: 0 auto;
        gap: var(--space-2xl);
        padding: var(--space-2xl) var(--space-lg);
    }

    .sidebar {
        position: sticky;
        top: 80px;
        height: fit-content;
    }

    .sidebar nav {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .sidebar a {
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }

    .sidebar a:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .sidebar a.active {
        background: var(--bg-tertiary);
        color: var(--gold-thread);
        border-left: 2px solid var(--gold-thread);
    }

    .content {
        max-width: 800px;
    }

    .doc-header {
        margin-bottom: var(--space-2xl);
        padding-bottom: var(--space-xl);
        border-bottom: 1px solid var(--border-subtle);
    }

    .doc-header h1 {
        margin: var(--space-sm) 0;
    }

    .subtitle {
        font-family: var(--font-display);
        color: var(--gold-thread);
        font-style: italic;
    }

    section {
        margin-bottom: var(--space-2xl);
    }

    section h2 {
        margin-bottom: var(--space-md);
        padding-bottom: var(--space-sm);
        border-bottom: 1px solid var(--border-subtle);
    }

    section h3 {
        font-size: 0.95rem;
        color: var(--gold-thread);
        margin: var(--space-lg) 0 var(--space-sm);
    }

    blockquote {
        border-left: 3px solid var(--gold-thread);
        padding-left: var(--space-lg);
        margin: var(--space-lg) 0;
        color: var(--text-secondary);
        font-style: italic;
    }

    .note {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .arch-grid,
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-md);
    }

    .arch-item,
    .metric {
        background: var(--bg-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
    }

    .arch-item h3,
    .metric-name {
        font-size: 1rem;
        color: var(--gold-thread);
        margin-bottom: var(--space-sm);
        font-family: var(--font-display);
    }

    .arch-item p,
    .metric-desc {
        font-size: 0.9rem;
        margin: 0;
        color: var(--text-secondary);
    }

    ol {
        padding-left: var(--space-lg);
        color: var(--text-secondary);
    }

    li {
        margin-bottom: var(--space-sm);
    }

    @media (max-width: 900px) {
        .doc-layout {
            grid-template-columns: 1fr;
        }

        .sidebar {
            position: relative;
            top: 0;
        }

        .sidebar nav {
            flex-direction: row;
            flex-wrap: wrap;
        }
    }
</style>
